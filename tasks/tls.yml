# Securely send your logs to Loggly using TLS encryption. 
# https://www.loggly.com/docs/rsyslog-tls-configuration/

- name: TLS | Install required software
  package:
    name: rsyslog-gnutls
    state: present

- name: TLS | Ensure key directory exists
  file:
    path: '{{ rsyslog_cert_path }}'
    state: directory
    mode: 0644

## use specific certificate
- block:
  - name: TLS | check for existing certificates
    find:
      path: "{{ rsyslog_cert_path }}"
      patterns: "*"
      recurse: no
    register: found_files
    changed_when: false
  - name: TLS | remove unexpected certificates
    file: path={{ item.path }} state=absent
    with_items: '{{ found_files.files }}'
    when: rsyslog_cert not in item.path
    ignore_errors: True
  - name: TLS | Download certificate
    get_url:
      url: "{{ rsyslog_services[rsyslog_srv].cert_path }}{{ rsyslog_services[rsyslog_srv].cert_name }}"
      dest: "{{ rsyslog_cert_path }}/{{ rsyslog_cert }}"
  when: rsyslog_services[rsyslog_srv].cert_name is defined
